import streamlit as st
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime
import time
import gspread.exceptions
import requests
import re
from streamlit_autorefresh import st_autorefresh

# ====== ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 6 Ø¯Ù‚Ø§Ø¦Ù‚ ======
st_autorefresh(interval=360*1000, key="auto_refresh")

# ====== Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬ÙˆØ¬Ù„ Ø´ÙŠØª ======
scope = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
creds_dict = st.secrets["gcp_service_account"]
creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
client = gspread.authorize(creds)

# ====== Ø£ÙˆØ±Ø§Ù‚ Ø¬ÙˆØ¬Ù„ Ø´ÙŠØª ======
SHEET_NAME = "Complaints"
sheets_dict = {}
for title in ["Complaints", "Responded", "Archive", "Types", "Ù…Ø¹Ù„Ù‚ Ø§Ø±Ø§Ù…ÙƒØ³", "Ø£Ø±Ø´ÙŠÙ Ø£Ø±Ø§Ù…ÙƒØ³", "ReturnWarehouse", "Order Number"]:
    sheets_dict[title] = client.open(SHEET_NAME).worksheet(title)

complaints_sheet = sheets_dict["Complaints"]
responded_sheet = sheets_dict["Responded"]
archive_sheet = sheets_dict["Archive"]
types_sheet = sheets_dict["Types"]
aramex_pending = sheets_dict["Ù…Ø¹Ù„Ù‚ Ø§Ø±Ø§Ù…ÙƒØ³"]
aramex_archive = sheets_dict["Ø£Ø±Ø´ÙŠÙ Ø£Ø±Ø§Ù…ÙƒØ³"]
return_warehouse_sheet = sheets_dict["ReturnWarehouse"]
order_number_sheet = sheets_dict["Order Number"]

# ====== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙØ­Ø© ======
st.set_page_config(page_title="ğŸ“¢ Ù†Ø¸Ø§Ù… Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰", page_icon="âš ï¸")
st.title("âš ï¸ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰")

# ====== ØªØ­Ù…ÙŠÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ======
types_list = [row[0] for row in types_sheet.get_all_values()[1:]]

# ====== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† ReturnWarehouse ======
return_warehouse_data = return_warehouse_sheet.get_all_values()[1:]
def get_returnwarehouse_record(order_id):
    for row in return_warehouse_data:
        if str(row[0]) == str(order_id):
            return {
                "Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨": row[0],
                "Ø§Ù„ÙØ§ØªÙˆØ±Ø©": row[1],
                "Ø§Ù„ØªØ§Ø±ÙŠØ®": row[2],
                "Ø§Ù„Ø²Ø¨ÙˆÙ†": row[3],
                "Ø§Ù„Ù…Ø¨Ù„Øº": row[4],
                "Ø±Ù‚Ù… Ø§Ù„Ø´Ø­Ù†Ø©": row[5],
                "Ø§Ù„Ø¨ÙŠØ§Ù†": row[6]
            }
    return None

# ====== Ù‚Ø±Ø§Ø¡Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ======
order_number_data = order_number_sheet.get_all_values()[1:]
def get_order_status(order_id):
    for row in order_number_data:
        if str(row[1]) == str(order_id):
            delegate = row[3] if len(row) > 3 else ""
            if delegate.strip().lower() == "aramex":
                return "ğŸ“¦ Ù…Ø´Ø­ÙˆÙ†Ø© Ù…Ø¹ Ø£Ø±Ø§Ù…ÙƒØ³ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø§Ø³Ø§Ø³ÙŠ"
            elif delegate.strip():
                return f"ğŸšš Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø§Ø³Ø§Ø³ÙŠ Ù…Ø´Ø­ÙˆÙ†Ø© Ù…Ø¹ Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ø±ÙŠØ§Ø¶ ({delegate})"
            else:
                return "â³ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø§Ø³Ø§Ø³ÙŠ ØªØ­Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©"
    return "â³ ØªØ­Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©"

# ====== Ø¯ÙˆØ§Ù„ Ø£Ù…Ø§Ù† (Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø©) ======
def safe_append(sheet, row_data, retries=5, delay=1):
    for _ in range(retries):
        try:
            sheet.append_row(row_data)
            return True
        except gspread.exceptions.APIError:
            time.sleep(delay)
    st.error("âŒ ÙØ´Ù„ append_row Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª.")
    return False

def safe_update(sheet, cell_range, values, retries=5, delay=1):
    for _ in range(retries):
        try:
            sheet.update(cell_range, values)
            return True
        except gspread.exceptions.APIError:
            time.sleep(delay)
    st.error("âŒ ÙØ´Ù„ update Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª.")
    return False

def safe_delete(sheet, row_index, retries=5, delay=1):
    for _ in range(retries):
        try:
            sheet.delete_rows(row_index)
            return True
        except gspread.exceptions.APIError:
            time.sleep(delay)
    st.error("âŒ ÙØ´Ù„ delete_rows Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª.")
    return False

# ====== Ø£Ø±Ø§Ù…ÙƒØ³ ======
client_info = {
    "UserName": "fitnessworld525@gmail.com",
    "Password": "Aa12345678@",
    "Version": "v1",
    "AccountNumber": "71958996",
    "AccountPin": "657448",
    "AccountEntity": "RUH",
    "AccountCountryCode": "SA"
}

def get_aramex_status(awb_number):
    try:
        headers = {"Content-Type": "application/json"}
        payload = {
            "ClientInfo": client_info,
            "Shipments": [awb_number],
            "Transaction": {"Reference1": "", "Reference2": "", "Reference3": "", "Reference4": "", "Reference5": ""},
            "LabelInfo": None
        }
        url = "https://ws.aramex.net/ShippingAPI.V2/Tracking/Service_1_0.svc/json/TrackShipments"
        response = requests.post(url, json=payload, headers=headers, timeout=6)
        if response.status_code != 200:
            return f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ ({response.status_code})"
        data = response.json()
        results = data.get("TrackingResults", [])
        if not results or not results[0].get("Value"):
            return "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØªØ¨Ø¹"
        updates = results[0]["Value"]
        desc = updates[-1].get("UpdateDescription", "â€”")
        return desc
    except Exception as e:
        return f"âš ï¸ Ø®Ø·Ø£: {e}"

# ====== Ø¹Ø±Ø¶ Ø§Ù„Ø´ÙƒÙˆÙ‰ ======
def render_complaint(sheet, i, row, in_responded=False, in_archive=False):
    comp_id, comp_type, notes, action, date_added = row[:5]
    restored = row[5] if len(row) > 5 else ""
    outbound_awb = row[6] if len(row) > 6 else ""
    inbound_awb = row[7] if len(row) > 7 else ""

    order_status = get_order_status(comp_id)

    with st.expander(f"ğŸ†” {comp_id} | ğŸ“Œ {comp_type} | ğŸ“… {date_added} | {order_status}"):
        with st.form(key=f"form_{comp_id}_{sheet.title}"):
            st.write(f"ğŸ“‹ Ø§Ù„Ù†ÙˆØ¹: {comp_type}")
            st.write(f"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: {notes}")
            st.write(f"âœ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: {action}")
            st.caption(f"ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„: {date_added}")

            rw_record = get_returnwarehouse_record(comp_id)
            if rw_record:
                st.info(
                    f"ğŸ“¦ Ø³Ø¬Ù„ ReturnWarehouse:\n"
                    f"Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: {rw_record['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']}\n"
                    f"Ø§Ù„ÙØ§ØªÙˆØ±Ø©: {rw_record['Ø§Ù„ÙØ§ØªÙˆØ±Ø©']}\n"
                    f"Ø§Ù„ØªØ§Ø±ÙŠØ®: {rw_record['Ø§Ù„ØªØ§Ø±ÙŠØ®']}\n"
                    f"Ø§Ù„Ø²Ø¨ÙˆÙ†: {rw_record['Ø§Ù„Ø²Ø¨ÙˆÙ†']}\n"
                    f"Ø§Ù„Ù…Ø¨Ù„Øº: {rw_record['Ø§Ù„Ù…Ø¨Ù„Øº']}\n"
                    f"Ø±Ù‚Ù… Ø§Ù„Ø´Ø­Ù†Ø©: {rw_record['Ø±Ù‚Ù… Ø§Ù„Ø´Ø­Ù†Ø©']}\n"
                    f"Ø§Ù„Ø¨ÙŠØ§Ù†: {rw_record['Ø§Ù„Ø¨ÙŠØ§Ù†']}"
                )

            new_type = st.selectbox("âœï¸ Ø¹Ø¯Ù„ Ø§Ù„Ù†ÙˆØ¹", [comp_type] + [t for t in types_list if t != comp_type])
            new_notes = st.text_area("âœï¸ Ø¹Ø¯Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª", value=notes)
            new_action = st.text_area("âœï¸ Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", value=action)
            new_outbound = st.text_input("ğŸ“¦ Outbound AWB", value=outbound_awb)
            new_inbound = st.text_input("ğŸ“¦ Inbound AWB", value=inbound_awb)

            if new_outbound:
                st.info(f"ğŸšš Outbound Ø­Ø§Ù„Ø©: {get_aramex_status(new_outbound)}")
            if new_inbound:
                st.info(f"ğŸ“¦ Inbound Ø­Ø§Ù„Ø©: {get_aramex_status(new_inbound)}")

            col1, col2, col3, col4 = st.columns(4)
            save = col1.form_submit_button("ğŸ’¾ Ø­ÙØ¸")
            delete = col2.form_submit_button("ğŸ—‘ï¸ Ø­Ø°Ù")
            archive = col3.form_submit_button("ğŸ“¦ Ø£Ø±Ø´ÙØ©")
            move = col4.form_submit_button("â¡ï¸ Ù†Ù‚Ù„" if not in_responded else "â¬…ï¸ Ø±Ø¬ÙˆØ¹")

            if save:
                safe_update(sheet, f"B{i}", [[new_type]])
                safe_update(sheet, f"C{i}", [[new_notes]])
                safe_update(sheet, f"D{i}", [[new_action]])
                safe_update(sheet, f"G{i}", [[new_outbound]])
                safe_update(sheet, f"H{i}", [[new_inbound]])
                st.success("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸.")

            if delete:
                safe_delete(sheet, i)
                st.warning("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù.")

            if archive:
                safe_append(archive_sheet, [comp_id, new_type, new_notes, new_action, date_added, restored, new_outbound, new_inbound])
                safe_delete(sheet, i)
                st.success("ğŸ“¦ ØªÙ… Ø§Ù„Ø£Ø±Ø´ÙØ©.")

            if move:
                if not in_responded:
                    safe_append(responded_sheet, [comp_id, new_type, new_notes, new_action, date_added, restored, new_outbound, new_inbound])
                    safe_delete(sheet, i)
                    st.success("â¡ï¸ ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ù„Ù„Ù…Ø±Ø¯ÙˆØ¯Ø©.")
                else:
                    safe_append(complaints_sheet, [comp_id, new_type, new_notes, new_action, date_added, restored, new_outbound, new_inbound])
                    safe_delete(sheet, i)
                    st.success("â¬…ï¸ ØªÙ…Øª Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø© Ù„Ù„Ù†Ø´Ø·Ø©.")

# ====== Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯Ø© ======
st.header("âœ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯Ø©:")
responded_notes = responded_sheet.get_all_values()
if len(responded_notes) > 1:
    types_in_responded = list({row[1] for row in responded_notes[1:]})
    for complaint_type in types_in_responded:
        with st.expander(f"ğŸ“Œ Ù†ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰: {complaint_type}"):
            type_rows = [(i, row) for i, row in enumerate(responded_notes[1:], start=2) if row[1] == complaint_type]

            followup_1, followup_2, others = [], [], []

            for i, row in type_rows:
                comp_id = row[0]
                outbound_awb = row[6] if len(row) > 6 else ""
                inbound_awb = row[7] if len(row) > 7 else ""
                rw_record = get_returnwarehouse_record(comp_id)

                delivered = False
                for awb in [outbound_awb, inbound_awb]:
                    if awb and "Delivered" in get_aramex_status(awb):
                        delivered = True
                        break

                if delivered and rw_record:
                    followup_2.append((i, row))
                elif delivered:
                    followup_1.append((i, row))
                else:
                    others.append((i, row))

            if followup_1:
                with st.expander("ğŸ“‹ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© 1"):
                    for i, row in followup_1:
                        render_complaint(responded_sheet, i, row, in_responded=True)
            if followup_2:
                with st.expander("ğŸ“‹ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© 2"):
                    for i, row in followup_2:
                        render_complaint(responded_sheet, i, row, in_responded=True)
            if others:
                with st.expander("ğŸ“‹ ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©"):
                    for i, row in others:
                        render_complaint(responded_sheet, i, row, in_responded=True)
else:
    st.info("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙƒØ§ÙˆÙ‰ Ù…Ø±Ø¯ÙˆØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.")

# ====== Ù‚Ø³Ù… Ø§Ù„Ø£Ø±Ø´ÙŠÙ ======
st.header("ğŸ“¦ Ø§Ù„Ø£Ø±Ø´ÙŠÙ:")
archive_data = archive_sheet.get_all_values()
if len(archive_data) > 1:
    limit = st.session_state.get("archive_limit", 50)
    for i, row in enumerate(archive_data[1:limit+1], start=2):
        render_complaint(archive_sheet, i, row, in_archive=True)
    if len(archive_data) - 1 > limit:
        if st.button("Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯..."):
            st.session_state["archive_limit"] = limit + 50
else:
    st.info("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙƒØ§ÙˆÙ‰ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ.")

# ====== Ù‚Ø³Ù… Ø£Ø±Ø§Ù…ÙƒØ³ ======
st.header("ğŸ“¦ Ø´ÙƒØ§ÙˆÙ‰ Ø£Ø±Ø§Ù…ÙƒØ³:")
aramex_pending_data = aramex_pending.get_all_values()
if len(aramex_pending_data) > 1:
    for i, row in enumerate(aramex_pending_data[1:], start=2):
        render_complaint(aramex_pending, i, row)
else:
    st.info("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙƒØ§ÙˆÙ‰ Ù…Ø¹Ù„Ù‚Ø© ÙÙŠ Ø£Ø±Ø§Ù…ÙƒØ³.")

aramex_archive_data = aramex_archive.get_all_values()
if len(aramex_archive_data) > 1:
    with st.expander("ğŸ“š Ø£Ø±Ø´ÙŠÙ Ø£Ø±Ø§Ù…ÙƒØ³"):
        for i, row in enumerate(aramex_archive_data[1:], start=2):
            render_complaint(aramex_archive, i, row, in_archive=True)
else:
    st.info("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙƒØ§ÙˆÙ‰ ÙÙŠ Ø£Ø±Ø´ÙŠÙ Ø£Ø±Ø§Ù…ÙƒØ³.")
