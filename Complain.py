import streamlit as st
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime
import time
import requests
import xml.etree.ElementTree as ET

# ====== Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬ÙˆØ¬Ù„ Ø´ÙŠØª ======
scope = ["https://www.googleapis.com/auth/spreadsheets",
         "https://www.googleapis.com/auth/drive"]

creds_dict = st.secrets["gcp_service_account"]
creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
client = gspread.authorize(creds)

# ====== Ø£ÙˆØ±Ø§Ù‚ Ø¬ÙˆØ¬Ù„ Ø´ÙŠØª ======
SHEET_NAME = "Complaints"
sheets_dict = {}
for title in ["Complaints", "Responded", "Archive", "Types", "Ù…Ø¹Ù„Ù‚ Ø§Ø±Ø§Ù…ÙƒØ³", "Ø£Ø±Ø´ÙŠÙ Ø£Ø±Ø§Ù…ÙƒØ³"]:
    sheets_dict[title] = client.open(SHEET_NAME).worksheet(title)

complaints_sheet = sheets_dict["Complaints"]
responded_sheet = sheets_dict["Responded"]
archive_sheet = sheets_dict["Archive"]
types_sheet = sheets_dict["Types"]
aramex_sheet = sheets_dict["Ù…Ø¹Ù„Ù‚ Ø§Ø±Ø§Ù…ÙƒØ³"]
aramex_archive = sheets_dict["Ø£Ø±Ø´ÙŠÙ Ø£Ø±Ø§Ù…ÙƒØ³"]

# ====== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© ======
st.set_page_config(page_title="ğŸ“¢ Ù†Ø¸Ø§Ù… Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰", page_icon="âš ï¸")
st.title("âš ï¸ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰")

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
types_list = [row[0] for row in types_sheet.get_all_values()[1:]]

# ====== Ø¯ÙˆØ§Ù„ Retry ======
def safe_append(sheet, row_data, retries=5, delay=1):
    for attempt in range(retries):
        try:
            sheet.append_row(row_data)
            return True
        except gspread.exceptions.APIError:
            time.sleep(delay)
    st.error("âŒ ÙØ´Ù„ append_row Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª.")
    return False

def safe_update(sheet, cell_range, values, retries=5, delay=1):
    for attempt in range(retries):
        try:
            sheet.update(cell_range, values)
            return True
        except gspread.exceptions.APIError:
            time.sleep(delay)
    st.error("âŒ ÙØ´Ù„ update Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª.")
    return False

def safe_delete(sheet, row_index, retries=5, delay=1):
    for attempt in range(retries):
        try:
            sheet.delete_rows(row_index)
            return True
        except gspread.exceptions.APIError:
            time.sleep(delay)
    st.error("âŒ ÙØ´Ù„ delete_rows Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª.")
    return False

# ====== Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø´Ø­Ù†Ø© Ø£Ø±Ø§Ù…ÙƒØ³ (XML + JSON fallback) ======
def get_aramex_status(awb_number):
    if not awb_number.strip():
        return "Ø±Ù‚Ù… Ø§Ù„Ø´Ø­Ù†Ø© ÙØ§Ø±Øº"
    try:
        client_info = {
            "UserName": "fitnessworld525@gmail.com",
            "Password": "Aa12345678@",
            "Version": "v1",
            "AccountNumber": "71958996",
            "AccountPin": "657448",
            "AccountEntity": "RUH",
            "AccountCountryCode": "SA"
        }

        url = "https://ws.aramex.net/ShippingAPI.V2/Tracking/Service_1_0.svc"
        payload = {
            "ClientInfo": client_info,
            "Transaction": {"Reference1": "12345"},
            "Shipments": [awb_number],
            "GetLastUpdateOnly": True
        }

        headers = {"Content-Type": "application/json"}
        response = requests.post(url, json=payload, headers=headers, timeout=10)

        if not response.text.strip():
            return "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¯ Ù…Ù† Ø£Ø±Ø§Ù…ÙƒØ³"

        # Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø¯ Ù„ XML
        root = ET.fromstring(response.text)
        ns = {'ns': 'http://ws.aramex.net/ShippingAPI/v1/'}
        track_result = root.find('.//ns:TrackingResult', ns)
        if track_result is None:
            return "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© ØªØªØ¨Ø¹"

        last_update = track_result.find('.//ns:Update', ns)
        if last_update is None:
            return "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ù…ØªØ§Ø­Ø©"

        status = last_update.find('ns:Status', ns)
        date = last_update.find('ns:Date', ns)
        return f"{status.text if status is not None else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'} Ø¨ØªØ§Ø±ÙŠØ® {date.text if date is not None else ''}"

    except Exception as e:
        return f"Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©: {e}"

# ====== Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†ÙˆØ¹ ======
def render_complaint(sheet, i, row, in_responded=False):
    comp_id, comp_type, notes, action, date_added = row[:5]
    restored = row[5] if len(row) > 5 else ""
    outbound_awb = row[6] if len(row) > 6 else ""
    inbound_awb = row[7] if len(row) > 7 else ""

    with st.expander(f"ğŸ†” {comp_id} | ğŸ“Œ {comp_type} | ğŸ“… {date_added} {restored}"):
        st.write(f"ğŸ“Œ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: {comp_type}")
        st.write(f"ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: {notes}")
        st.write(f"âœ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: {action}")
        st.caption(f"ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {date_added}")

        if outbound_awb:
            st.info(f"ğŸšš Outbound AWB: {outbound_awb} | Ø§Ù„Ø­Ø§Ù„Ø©: {get_aramex_status(outbound_awb)}")
        if inbound_awb:
            st.info(f"ğŸ“¦ Inbound AWB: {inbound_awb} | Ø§Ù„Ø­Ø§Ù„Ø©: {get_aramex_status(inbound_awb)}")

        # ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡
        new_type = st.selectbox("âœï¸ Ø¹Ø¯Ù„ Ù†ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰",
                                [comp_type] + [t for t in types_list if t != comp_type],
                                index=0, key=f"type_{comp_id}_{sheet.title}")
        new_notes = st.text_area("âœï¸ Ø¹Ø¯Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª", value=notes, key=f"notes_{comp_id}_{sheet.title}")
        new_action = st.text_area("âœï¸ Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", value=action, key=f"action_{comp_id}_{sheet.title}")

        col1, col2, col3, col4 = st.columns(4)

        if col1.button("ğŸ’¾ Ø­ÙØ¸", key=f"save_{comp_id}_{sheet.title}"):
            safe_update(sheet, f"B{i}", [[new_type]])
            safe_update(sheet, f"C{i}", [[new_notes]])
            safe_update(sheet, f"D{i}", [[new_action]])
            st.success("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„")
            st.rerun()

        if col2.button("ğŸ—‘ï¸ Ø­Ø°Ù", key=f"delete_{comp_id}_{sheet.title}"):
            safe_delete(sheet, i)
            st.warning("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´ÙƒÙˆÙ‰")
            st.rerun()

        if col3.button("ğŸ“¦ Ø£Ø±Ø´ÙØ©", key=f"archive_{comp_id}_{sheet.title}"):
            safe_append(archive_sheet, [comp_id, new_type, new_notes, new_action, date_added, restored, outbound_awb, inbound_awb])
            time.sleep(0.5)
            safe_delete(sheet, i)
            st.success("â™»ï¸ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù†ØªÙ‚Ù„Øª Ù„Ù„Ø£Ø±Ø´ÙŠÙ")
            st.rerun()

        if not in_responded:
            if col4.button("â¡ï¸ Ù†Ù‚Ù„ Ù„Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯Ø©", key=f"to_responded_{comp_id}_{sheet.title}"):
                safe_append(responded_sheet, [comp_id, new_type, new_notes, new_action, date_added, restored, outbound_awb, inbound_awb])
                time.sleep(0.5)
                safe_delete(sheet, i)
                st.success("âœ… Ø§ØªÙ†Ù‚Ù„Øª Ù„Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯Ø©")
                st.rerun()
        else:
            if col4.button("â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù†Ø´Ø·Ø©", key=f"to_active_{comp_id}_{sheet.title}"):
                safe_append(complaints_sheet, [comp_id, new_type, new_notes, new_action, date_added, restored, outbound_awb, inbound_awb])
                time.sleep(0.5)
                safe_delete(sheet, i)
                st.success("âœ… Ø§ØªÙ†Ù‚Ù„Øª Ù„Ù„Ù†Ø´Ø·Ø©")
                st.rerun()
